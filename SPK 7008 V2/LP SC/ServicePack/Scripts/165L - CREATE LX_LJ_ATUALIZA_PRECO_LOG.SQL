Create PROCEDURE [dbo].[LX_LJ_ATUALIZA_PRECO_LOG]
AS

-- Wendel Crespigio  - 19/06/2018 - #1# - Demanda 80031 - Mehoria de performance na entrada do sisma  
BEGIN
	SET NOCOUNT ON

	UPDATE
		A
	SET 
		PRECO1 = B.PRECO1, PRECO2 = B.PRECO2, PRECO3 = B.PRECO3, PRECO4 = B.PRECO4, 
		PRECO_LIQUIDO1 = B.PRECO_LIQUIDO1, PRECO_LIQUIDO2 = B.PRECO_LIQUIDO2, PRECO_LIQUIDO3 = B.PRECO_LIQUIDO3, PRECO_LIQUIDO4 = B.PRECO_LIQUIDO4, 
		PROMOCAO_DESCONTO = B.PROMOCAO_DESCONTO, INICIO_PROMOCAO = B.INICIO_PROMOCAO, FIM_PROMOCAO = B.FIM_PROMOCAO
	FROM
		PRODUTOS_PRECO_COR A 
		INNER JOIN PRODUTOS_PRECO_COR_LOG B ON A.CODIGO_TAB_PRECO = B.CODIGO_TAB_PRECO AND A.PRODUTO = B.PRODUTO AND A.COR_PRODUTO = B.COR_PRODUTO 
	WHERE
		ISNULL(B.PROCESSADO, '0') != '1' AND B.DATA_ATIVACAO <= GETDATE()
	
	UPDATE PRODUTOS_PRECO_COR_LOG SET PROCESSADO = '1' WHERE ISNULL(PROCESSADO, '0') != '1' AND DATA_ATIVACAO <= GETDATE()
	
	UPDATE
		A
	SET 
		PRECO1 = B.PRECO1, PRECO2 = B.PRECO2, PRECO3 = B.PRECO3, PRECO4 = B.PRECO4, 
		PRECO_LIQUIDO1 = B.PRECO_LIQUIDO1, PRECO_LIQUIDO2 = B.PRECO_LIQUIDO2, PRECO_LIQUIDO3 = B.PRECO_LIQUIDO3, PRECO_LIQUIDO4 = B.PRECO_LIQUIDO4, 
		PROMOCAO_DESCONTO = B.PROMOCAO_DESCONTO, INICIO_PROMOCAO = B.INICIO_PROMOCAO, FIM_PROMOCAO = B.FIM_PROMOCAO, 
		ULT_ATUALIZACAO = CONVERT(DATETIME, CONVERT(VARCHAR, GETDATE(), 112)) 
	FROM
		PRODUTOS_PRECOS A 
		INNER JOIN PRODUTOS_PRECO_LOG B ON A.CODIGO_TAB_PRECO = B.CODIGO_TAB_PRECO AND A.PRODUTO = B.PRODUTO 
	WHERE
		ISNULL(B.PROCESSADO, '0') != '1' AND B.DATA_ATIVACAO <= GETDATE()
	
	UPDATE PRODUTOS_PRECO_LOG SET PROCESSADO = '1' WHERE ISNULL(PROCESSADO, '0') != '1' AND DATA_ATIVACAO <= GETDATE()
	
	UPDATE
		A
	SET 
		PRECO1 = B.PRECO1, PRECO2 = B.PRECO2, PRECO3 = B.PRECO3, PRECO4 = B.PRECO4, 
		PRECO_LIQUIDO1 = B.PRECO_LIQUIDO1, PRECO_LIQUIDO2 = B.PRECO_LIQUIDO2, PRECO_LIQUIDO3 = B.PRECO_LIQUIDO3, PRECO_LIQUIDO4 = B.PRECO_LIQUIDO4, 
		PROMOCAO_DESCONTO = B.PROMOCAO_DESCONTO, INICIO_PROMOCAO = B.INICIO_PROMOCAO, FIM_PROMOCAO = B.FIM_PROMOCAO
	FROM
		PRODUTOS_PRECO_FILIAL A 
		INNER JOIN PRODUTOS_PRECO_FILIAL_LOG B ON A.CODIGO_TAB_PRECO = B.CODIGO_TAB_PRECO AND A.PRODUTO = B.PRODUTO AND A.COR_PRODUTO = B.COR_PRODUTO AND A.FILIAL = B.FILIAL
	WHERE
		ISNULL(B.PROCESSADO, '0') != '1' AND B.DATA_ATIVACAO <= GETDATE()
	
	UPDATE PRODUTOS_PRECO_FILIAL_LOG SET PROCESSADO = '1' WHERE ISNULL(PROCESSADO, '0') != '1' AND DATA_ATIVACAO <= GETDATE()
	
		update PRODUTOS_PRECO_COR  set  LX_HASH = HASHBYTES('MD5', '6380330E7310A521B8DACC8FCB51478DB48661614820D15D430D90C31007F4BB614911817E4B' + CODIGO_TAB_PRECO + PRODUTO + COR_PRODUTO + CAST(ISNULL(PRECO1, 0) AS VARCHAR)  + CAST(ISNULL(PRECO2, 0) AS VARCHAR) + CAST(ISNULL(PRECO3, 0) AS VARCHAR) + CAST(ISNULL(PRECO4, 0) AS VARCHAR)) 
		where LX_HASH <> HASHBYTES('MD5', '6380330E7310A521B8DACC8FCB51478DB48661614820D15D430D90C31007F4BB614911817E4B' + CODIGO_TAB_PRECO + PRODUTO + COR_PRODUTO + CAST(ISNULL(PRECO1, 0) AS VARCHAR)  + CAST(ISNULL(PRECO2, 0) AS VARCHAR) + CAST(ISNULL(PRECO3, 0) AS VARCHAR) + CAST(ISNULL(PRECO4, 0) AS VARCHAR)) --#1#
  
       update PRODUTOS_PRECOS set  LX_HASH = HASHBYTES('MD5', '6380330E7310A521B8DACC8FCB51478DB48661614820D15D430D90C31007F4BB614911817E4B'  + CODIGO_TAB_PRECO + PRODUTO + 
       CAST(ISNULL(PRECO1, 0) AS VARCHAR)  + CAST(ISNULL(PRECO2, 0) AS VARCHAR) + CAST(ISNULL(PRECO3, 0) AS VARCHAR) + CAST(ISNULL(PRECO4, 0) AS VARCHAR)) --#1#
	   where LX_HASH <> HASHBYTES('MD5', '6380330E7310A521B8DACC8FCB51478DB48661614820D15D430D90C31007F4BB614911817E4B'  + CODIGO_TAB_PRECO + PRODUTO + CAST(ISNULL(PRECO1, 0) AS VARCHAR)  + CAST(ISNULL(PRECO2, 0) AS VARCHAR) + CAST(ISNULL(PRECO3, 0) AS VARCHAR) + CAST(ISNULL(PRECO4, 0) AS VARCHAR)) --#1#
       
      update PRODUTOS_PRECO_FILIAL set  LX_HASH = HASHBYTES('MD5', '6380330E7310A521B8DACC8FCB51478DB48661614820D15D430D90C31007F4BB614911817E4B'  + CODIGO_TAB_PRECO + 
		FILIAL+PRODUTO +  COR_PRODUTO  +  CAST(ISNULL(PRECO1, 0) AS VARCHAR)  + CAST(ISNULL(PRECO2, 0) AS VARCHAR) + CAST(ISNULL(PRECO3, 0) AS VARCHAR) + CAST(ISNULL(PRECO4, 0) AS VARCHAR))
		where LX_HASH <> HASHBYTES('MD5', '6380330E7310A521B8DACC8FCB51478DB48661614820D15D430D90C31007F4BB614911817E4B'  + CODIGO_TAB_PRECO + FILIAL+PRODUTO +  COR_PRODUTO + CAST(ISNULL(PRECO1, 0) AS VARCHAR)  + CAST(ISNULL(PRECO2, 0) AS VARCHAR) + CAST(ISNULL(PRECO3, 0) AS VARCHAR) + CAST(ISNULL(PRECO4, 0) AS VARCHAR)) --#1#

	
	SET NOCOUNT OFF
END

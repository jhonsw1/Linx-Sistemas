
Create PROCEDURE [DBO].[LX_LIMPEZA_ESTOQUE_PAF_ECF] ( @CODIGO_FILIAL VARCHAR(6), @GERA_ARQUIVO_MENSAL INT, @LOCAL_UF VARCHAR(2))  
  
-- 19/02/2021 - Wendel Crespigio - SUSTSP-2268 #1# - ALterado o nome do objeto de BLOCOX_CONTROLE_GERA_XML para LJ_BLOCOX_CONTROLE_GERA_XML nome novo da tabela apos normalização.
AS  
  
BEGIN   
   
 SELECT DISTINCT(CAST(DATA_FISCAL AS DATE)) AS DATA_FISCAL   
 INTO #LOJA_CONTROLE_FISCAL   
 FROM LOJA_CONTROLE_FISCAL   
 WHERE CODIGO_FILIAL = @CODIGO_FILIAL AND CAST(DATA_FISCAL  AS DATE) < CAST(GETDATE() - 5 AS DATE) AND DATA_FISCAL > GETDATE() - 30    
  
 DECLARE @DATA_INI DATE  
 SELECT @DATA_INI = DATA_INICIO FROM LX_CONFIG_BLOCOX WHERE UF = @LOCAL_UF  
  
 SELECT MIN(DATA_PAF_ECF) PRIMEIRA_FOTO_MES INTO #FOTOS_MENSAIS   
 FROM LJ_ESTOQUE_PAF_ECF   
 WHERE DATA_PAF_ECF >= DATEADD(month, 1, @DATA_INI)  
 GROUP BY MONTH(DATA_PAF_ECF),YEAR(DATA_PAF_ECF)     
 ORDER BY 1  
  

 SELECT F.PRIMEIRA_FOTO_MES AS DATA_MES INTO #DATAS_BLOCOX  
 FROM #FOTOS_MENSAIS F  
 LEFT JOIN LJ_BLOCOX_CONTROLE_GERA_XML X  --#1#
 ON YEAR(DATEADD(month, -1, F.PRIMEIRA_FOTO_MES)) = YEAR(X.DATA_MES) AND MONTH(DATEADD(month, -1, F.PRIMEIRA_FOTO_MES)) = MONTH(X.DATA_MES) AND X.TIPO_ARQUIVO = 'EM'  
 WHERE (X.SITUACAO <> 6 AND X.COD_RET_SEFAZ <> 2) OR X.ID_BLOCOX IS NULL  
  
 IF @GERA_ARQUIVO_MENSAL = 1  
 BEGIN  
  DELETE FROM LJ_ESTOQUE_PAF_ECF  
  WHERE   
  CODIGO_FILIAL = @CODIGO_FILIAL  AND   
  ( (DATA_PAF_ECF IN (SELECT * FROM #LOJA_CONTROLE_FISCAL) OR DATA_PAF_ECF <= GETDATE() - 30)  
     AND DATA_PAF_ECF NOT IN (SELECT * FROM #DATAS_BLOCOX) )   
  
  DELETE FROM LJ_ESTOQUE_PAF_ECF_CUPOM  
  WHERE   
  CODIGO_FILIAL = @CODIGO_FILIAL  AND   
  ( (DATA_PAF_ECF IN (SELECT * FROM #LOJA_CONTROLE_FISCAL) OR DATA_PAF_ECF <= GETDATE() - 30)  
     AND DATA_PAF_ECF NOT IN (SELECT * FROM #DATAS_BLOCOX) )   
 END  
 ELSE  
  BEGIN  
  DELETE FROM LJ_ESTOQUE_PAF_ECF  
  WHERE   
  CODIGO_FILIAL = @CODIGO_FILIAL  AND   
  ( DATA_PAF_ECF IN (SELECT * FROM #LOJA_CONTROLE_FISCAL)  
    OR DATA_PAF_ECF <= GETDATE() - 30 )   
  
  DELETE FROM LJ_ESTOQUE_PAF_ECF_CUPOM  
  WHERE   
  CODIGO_FILIAL = @CODIGO_FILIAL  AND   
  ( DATA_PAF_ECF IN (SELECT * FROM #LOJA_CONTROLE_FISCAL)  
    OR DATA_PAF_ECF <= GETDATE() - 30 )   
  END  
  
END
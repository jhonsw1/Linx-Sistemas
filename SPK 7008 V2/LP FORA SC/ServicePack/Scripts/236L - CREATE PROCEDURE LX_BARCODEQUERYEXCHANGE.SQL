CREATE PROCEDURE LX_BarcodeQueryExchange (@strPriceTable VARCHAR(20) = '', @strBarCode VARCHAR(25) = NULL, @strProduct CHAR(12) = NULL, @strProductColor CHAR(10) = NULL, @strStartDate CHAR(8)= null, @strFinishDate CHAR(8)= null)
AS
SET NOCOUNT ON

DECLARE @strQuery VARCHAR(8000)

set @strQuery = 'SELECT DISTINCT F.CODIGO_BARRA, A.PRODUTO, B.COR_PRODUTO, F.GRADE, F.TAMANHO, DESCRICAO = RTRIM(A.DESC_PROD_NF) + '' - '' + RTRIM(B.DESC_COR_PRODUTO) + 
	'' - '' + RTRIM(F.GRADE), PRECO = CASE A.VARIA_PRECO_COR WHEN 1 THEN CASE SUBSTRING(A.PONTEIRO_PRECO_TAM, F.TAMANHO, 1) 
	WHEN 1 THEN D.PRECO1 WHEN 2 THEN D.PRECO2 WHEN 3 THEN D.PRECO3 WHEN 4 THEN D.PRECO4 END ELSE 
	CASE SUBSTRING(PONTEIRO_PRECO_TAM, F.TAMANHO, 1) WHEN 1 THEN C.PRECO1 WHEN 2 THEN C.PRECO2 WHEN 3 THEN C.PRECO3 WHEN 4 THEN C.PRECO4 END
	END, H.BARCODES, A.DESC_PROD_NF, B.DESC_COR_PRODUTO
	FROM PRODUTOS A INNER JOIN PRODUTO_CORES B ON A.PRODUTO = B.PRODUTO
	INNER JOIN PRODUTOS_PRECOS C ON A.PRODUTO = C.PRODUTO
	LEFT JOIN PRODUTOS_PRECO_COR D ON C.CODIGO_TAB_PRECO = D.CODIGO_TAB_PRECO AND C.PRODUTO = D.PRODUTO AND B.COR_PRODUTO = D.COR_PRODUTO
	INNER JOIN PRODUTOS_TAMANHOS E ON A.GRADE = E.GRADE
	INNER JOIN PRODUTOS_BARRA F ON A.PRODUTO = F.PRODUTO AND B.COR_PRODUTO = F.COR_PRODUTO
	INNER JOIN LOJA_VENDA_TROCA G ON F.CODIGO_BARRA = G.CODIGO_BARRA
	INNER JOIN (SELECT CODIGO_BARRA, SUM(QTDE) AS BARCODES FROM LOJA_VENDA_TROCA WHERE QTDE_CANCELADA = 0 '

IF @strStartDate IS NOT NULL
	SET @strQuery = @strQuery + 'AND DATA_VENDA BETWEEN ''' + @strStartDate + ''' AND ''' + @strFinishDate + ''''
	
SET @strQuery = @strQuery + '  GROUP BY CODIGO_BARRA) H ON G.CODIGO_BARRA = H.CODIGO_BARRA '

SET @strQuery = @strQuery + '  WHERE F.INATIVO = 0 AND C.CODIGO_TAB_PRECO = ''' + @strPriceTable + ''' '  -- @DM120325

IF @strBarCode IS NOT NULL	
	SET @strQuery = @strQuery + 'AND F.CODIGO_BARRA LIKE ''' + @strBarCode + ''' '  -- @DM120386

IF @strProduct IS NOT NULL	
	SET @strQuery = @strQuery + 'AND LTRIM(RTRIM(A.PRODUTO)) LIKE LTRIM(RTRIM(''' + @strProduct + ''')) '  -- @DM120386

IF @strProductColor IS NOT NULL	
	SET @strQuery = @strQuery + 'AND LTRIM(RTRIM(B.COR_PRODUTO)) LIKE LTRIM(RTRIM(''' + @strProductColor + ''')) '  -- @DM120386

IF @strStartDate IS NOT NULL
	SET @strQuery = @strQuery + 'AND G.DATA_VENDA BETWEEN ''' + @strStartDate + ''' AND ''' + @strFinishDate + ''''
	
SET @strQuery = @strQuery + ' ORDER BY A.PRODUTO, B.COR_PRODUTO, F.TAMANHO'

EXEC(@strQuery)

SET NOCOUNT OFF



CREATE FUNCTION [dbo].[FN_SALES_COMMISSIONS] (@StoreCode char(6), @StartDate datetime, @EndDate datetime)  
RETURNS TABLE  
AS  
RETURN  
 (  
 SELECT  
  A.CODIGO_FILIAL, A.TICKET, A.DATA_VENDA, A.CODIGO_CLIENTE, E.FILIAL,  
  C.VENDEDOR, D.VENDEDOR_APELIDO, D.NOME_VENDEDOR, D.COMISSAO AS ALIQUOTA,  
  D.CODIGO_FILIAL AS CODIGO_FILIAL_VENDEDOR,  
  SUM(ISNULL(F.QTDE_VENDA, 0)) AS PECAS_PRODUTO,  
  SUM(ISNULL(F.QTDE_TROCA, 0)) AS PECAS_TROCA,  
  SUM(ISNULL(CASE WHEN F.VALOR < 0 THEN 0 ELSE F.VALOR END, 0)) AS VALOR_VENDA_BRUTA,   
  SUM(ISNULL(CASE WHEN F.VALOR > 0 THEN 0 ELSE ABS(F.VALOR) END, 0)) AS VALOR_TROCA,   
  SUM(ISNULL(CASE WHEN F.VALOR < 0 THEN F.VALOR ELSE ISNULL(F.VALOR * (1 - CASE WHEN A.VALOR_VENDA_BRUTA = 0 THEN 0 ELSE (A.VALOR_VENDA_BRUTA - A.VALOR_TROCA - A.VALOR_PAGO) / A.VALOR_VENDA_BRUTA END), 0) END, 0)) AS VALOR_VENDA,   
  SUM(CASE WHEN F.VALOR < 0 THEN 0 ELSE ISNULL(F.VALOR * CASE WHEN A.VALOR_VENDA_BRUTA = 0 THEN 1 ELSE (A.VALOR_PAGO / A.VALOR_VENDA_BRUTA) END, 0) END) AS VALOR_LIQUIDO_VENDA,   
  CASE WHEN COUNT(DISTINCT F.ID_VENDEDOR) = 1 THEN SUM(DISTINCT ISNULL(C.COMISSAO, 0)) ELSE SUM(ISNULL(C.COMISSAO, 0)) END AS VALOR_COMISSAO,   
  SUM(ISNULL(F.QTDE_ITENS, 0)) AS QTDE_ITENS_PRODUTO,
  SUM(CASE WHEN A.VALOR_PAGO = 0 OR F.VALOR < 0 THEN 0 ELSE ISNULL(F.VALOR * CASE WHEN A.VALOR_VENDA_BRUTA = 0 THEN 1 ELSE (A.VALOR_PAGO / A.VALOR_VENDA_BRUTA) END, 0) / CONVERT(FLOAT, A.VALOR_PAGO) END) AS FATOR_LINHA   
 FROM  
  LOJA_VENDA A  
  INNER JOIN LOJA_VENDA_PGTO B ON A.CODIGO_FILIAL_PGTO = B.CODIGO_FILIAL AND A.TERMINAL_PGTO = B.TERMINAL AND A.LANCAMENTO_CAIXA = B.LANCAMENTO_CAIXA  
  INNER JOIN LOJA_VENDA_VENDEDORES C ON A.CODIGO_FILIAL = C.CODIGO_FILIAL AND A.TICKET = C.TICKET AND A.DATA_VENDA = C.DATA_VENDA  
  INNER JOIN LOJA_VENDEDORES D ON C.VENDEDOR = D.VENDEDOR  
  INNER JOIN LOJAS_VAREJO E ON A.CODIGO_FILIAL = E.CODIGO_FILIAL  
  LEFT JOIN dbo.FN_PRODUCTS_SALESMEN(@StoreCode, @StartDate, @EndDate) F ON C.CODIGO_FILIAL = F.CODIGO_FILIAL AND C.TICKET = F.TICKET AND C.DATA_VENDA = F.DATA_VENDA AND C.ID_VENDEDOR = F.ID_VENDEDOR  
 WHERE   
  A.DATA_HORA_CANCELAMENTO IS NULL   
  AND A.CODIGO_FILIAL = @StoreCode  
  AND A.DATA_VENDA BETWEEN ISNULL(@StartDate, A.DATA_VENDA) AND ISNULL(@EndDate, A.DATA_VENDA)  
 GROUP BY  
  A.CODIGO_FILIAL, A.TICKET, A.DATA_VENDA, A.CODIGO_CLIENTE, E.FILIAL,  
  C.VENDEDOR, D.VENDEDOR_APELIDO, D.NOME_VENDEDOR, D.COMISSAO, D.CODIGO_FILIAL
 )



CREATE PROCEDURE sp_BarcodeQuery (@strPriceTable VARCHAR(20) = '', @strBarCode VARCHAR(25) = NULL, @strProduct CHAR(12) = NULL, @strProductColor CHAR(10) = NULL, @strPedido varchar(08) = null, @strNF_SERIE varchar(22) = null )
AS
SET NOCOUNT ON

--25/11/2020 - Wendel Crespigio - Tratamento para quando a seria não for informada na chamada da procedure

DECLARE @strQuery VARCHAR(8000)

--Inicio #PRODSHOP-11844
if NOT exists (SELECT 1 FROM PRODUTOS_PRECO_FILIAL A INNER JOIN PRODUTOS_BARRA B ON A.PRODUTO = B.PRODUTO WHERE A.CODIGO_TAB_PRECO = @strPriceTable AND (A.PRODUTO = @strProduct OR B.CODIGO_BARRA = @strBarCode))

BEGIN

set @strQuery = 'SELECT F.CODIGO_BARRA, A.PRODUTO, B.COR_PRODUTO, F.GRADE, F.TAMANHO, DESCRICAO = RTRIM(A.DESC_PROD_NF) + '' - '' + RTRIM(B.DESC_COR_PRODUTO) + 
	'' - '' + RTRIM(F.GRADE), PRECO = CASE A.VARIA_PRECO_COR WHEN 1 THEN CASE SUBSTRING(A.PONTEIRO_PRECO_TAM, F.TAMANHO, 1) 
	WHEN 1 THEN D.PRECO1 WHEN 2 THEN D.PRECO2 WHEN 3 THEN D.PRECO3 WHEN 4 THEN D.PRECO4 END ELSE 
	CASE SUBSTRING(PONTEIRO_PRECO_TAM, F.TAMANHO, 1) WHEN 1 THEN C.PRECO1 WHEN 2 THEN C.PRECO2 WHEN 3 THEN C.PRECO3 WHEN 4 THEN C.PRECO4 END
	END, CONVERT(INTEGER, 0) AS BARCODES, A.DESC_PROD_NF, B.DESC_COR_PRODUTO
	FROM PRODUTOS A INNER JOIN PRODUTO_CORES B ON A.PRODUTO = B.PRODUTO
	INNER JOIN PRODUTOS_PRECOS C ON A.PRODUTO = C.PRODUTO
	LEFT JOIN PRODUTOS_PRECO_COR D ON C.CODIGO_TAB_PRECO = D.CODIGO_TAB_PRECO AND C.PRODUTO = D.PRODUTO AND B.COR_PRODUTO = D.COR_PRODUTO
	INNER JOIN PRODUTOS_TAMANHOS E ON A.GRADE = E.GRADE
	INNER JOIN PRODUTOS_BARRA F ON A.PRODUTO = F.PRODUTO AND B.COR_PRODUTO = F.COR_PRODUTO
	WHERE F.INATIVO = 0 AND C.CODIGO_TAB_PRECO = ''' + @strPriceTable + ''' '  -- @DM120325
END
  
ELSE

BEGIN 

set @strQuery = 'SELECT F.CODIGO_BARRA, A.PRODUTO, B.COR_PRODUTO, F.GRADE, F.TAMANHO, DESCRICAO = RTRIM(A.DESC_PROD_NF) + '' - '' + RTRIM(B.DESC_COR_PRODUTO) +   
 '' - '' + RTRIM(F.GRADE), PRECO = CASE A.VARIA_PRECO_COR WHEN 1 THEN CASE SUBSTRING(A.PONTEIRO_PRECO_TAM, F.TAMANHO, 1)   
 WHEN 1 THEN D.PRECO1 WHEN 2 THEN D.PRECO2 WHEN 3 THEN D.PRECO3 WHEN 4 THEN D.PRECO4 END ELSE   
 CASE SUBSTRING(PONTEIRO_PRECO_TAM, F.TAMANHO, 1) WHEN 1 THEN C.PRECO1 WHEN 2 THEN C.PRECO2 WHEN 3 THEN C.PRECO3 WHEN 4 THEN C.PRECO4 END
 END, CONVERT(INTEGER, 0) AS BARCODES, A.DESC_PROD_NF, B.DESC_COR_PRODUTO  
 FROM PRODUTOS A INNER JOIN PRODUTO_CORES B ON A.PRODUTO = B.PRODUTO  
 LEFT JOIN PRODUTOS_PRECO_FILIAL C ON A.PRODUTO = C.PRODUTO  AND B.COR_PRODUTO = C.COR_PRODUTO
 LEFT JOIN PRODUTOS_PRECO_COR D ON C.CODIGO_TAB_PRECO = D.CODIGO_TAB_PRECO AND C.PRODUTO = D.PRODUTO AND B.COR_PRODUTO = D.COR_PRODUTO  
 INNER JOIN PRODUTOS_TAMANHOS E ON A.GRADE = E.GRADE  
 INNER JOIN PRODUTOS_BARRA F ON A.PRODUTO = F.PRODUTO AND B.COR_PRODUTO = F.COR_PRODUTO  
 WHERE F.INATIVO = 0 AND C.CODIGO_TAB_PRECO = ''' + @strPriceTable + ''' '  -- @DM120325  
  
END
--Fim #PRODSHOP-11844

IF @strBarCode IS NOT NULL
	SET @strQuery = @strQuery + 'AND F.CODIGO_BARRA LIKE ''' + @strBarCode + ''' '  -- @DM120386

IF @strProduct IS NOT NULL
	SET @strQuery = @strQuery + 'AND LTRIM(RTRIM(A.PRODUTO)) LIKE LTRIM(RTRIM(''' + @strProduct + ''')) '  -- @DM120386

IF @strProductColor IS NOT NULL	
	SET @strQuery = @strQuery + 'AND LTRIM(RTRIM(B.COR_PRODUTO)) LIKE LTRIM(RTRIM(''' + @strProductColor + ''')) '  -- @DM120386

IF @strPedido IS NOT NULL
	SET @strQuery = @strQuery + 'AND ( A.PRODUTO + B.COR_PRODUTO) IN ( 
		SELECT DISTINCT PRODUTO + COR_PRODUTO 
		FROM LOJA_COMPRA_PRODUTO  
		WHERE PEDIDO = ''' + @strPedido + ''') '
		
IF @strNF_SERIE IS NOT NULL 
	SET @strQuery = @strQuery + 'AND ( A.PRODUTO + B.COR_PRODUTO) IN ( 
		SELECT DISTINCT H.PRODUTO + H.COR_PRODUTO 
		FROM LOJA_ENTRADAS G
		INNER JOIN LOJA_ENTRADAS_PRODUTO H ON G.ROMANEIO_PRODUTO = H.ROMANEIO_PRODUTO
					AND G.FILIAL = H.FILIAL
		WHERE RTRIM(RTRIM(G.NUMERO_NF_TRANSFERENCIA)) + 
				RTRIM(RTRIM(G.SERIE_NF_ENTRADA)) LIKE ' + CHAR(39) + '%' + @strNF_SERIE + '%' + CHAR(39) + ') '

SET @strQuery = @strQuery + 'ORDER BY A.PRODUTO, B.COR_PRODUTO, F.TAMANHO'

EXEC(@strQuery)

SET NOCOUNT OFF

